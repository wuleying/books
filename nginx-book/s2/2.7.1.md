# 请求的处理流程
***

&emsp;&emsp;
为了让大家更好的了解 nginx 中请求处理过程，以 HTTP Request 为例来做一下详细的说明。
从 nginx 的内部来看，一个 HTTP Request 的处理过程涉及到以下几个阶段。

+ 初始化 HTTP Request(读取来自客户端的数据，生成 HTTP Request 对象，该对象含有该请求所有的信息)。
+ 处理请求头。
+ 处理请求体。
+ 如果有的话调用与此请求( URL 或者 Location )关联的 handler。
+ 依次调用各 phase handler 进行处理。
+ 在这里需要了解一下 phase handler 这个概念。phase 字面的意思就是阶段。所以 phase handlers 也就好理解了，就是包含若干个处理阶段的一些 handler。

&emsp;&emsp;
在每一个阶段包含有若干个 handler，再处理到某个阶段的时候，依次调用该阶段的 handler 对 HTTP Request 进行处理。

&emsp;&emsp;
通常情况下，一个phase handler对这个request进行处理，并产生一些输出。通常phase handler是与定义在配置文件中的某个location相关联的。

&emsp;&emsp;
一个 phase handler 通常执行以下几项任务：

+ 获取 location 配置。
+ 产生适当的响应。
+ 发送 response header。
+ 发送 response body。

&emsp;&emsp;
当 nginx 读取到一个 HTTP Request 的 header 的时候，nginx 首先查找与这个请求关联的虚拟主机的配置。
如果找到了这个虚拟主机的配置，那么通常情况下，这个 HTTP Request 将会经过以下几个阶段的处理( phase handlers )：

+ NGX_HTTP_POST_READ_PHASE:                 读取请求内容阶段
+ NGX_HTTP_SERVER_REWRITE_PHASE: Server     请求地址重写阶段
+ NGX_HTTP_FIND_CONFIG_PHASE:               配置查找阶段
+ NGX_HTTP_REWRITE_PHASE: Location          请求地址重写阶段
+ NGX_HTTP_POST_REWRITE_PHASE:              请求地址重写提交阶段
+ NGX_HTTP_PREACCESS_PHASE:                 访问权限检查准备阶段
+ NGX_HTTP_ACCESS_PHASE:                    访问权限检查阶段
+ NGX_HTTP_POST_ACCESS_PHASE:               访问权限检查提交阶段
+ NGX_HTTP_TRY_FILES_PHASE:                 配置项 try_files 处理阶段
+ NGX_HTTP_CONTENT_PHASE:                   内容产生阶段
+ NGX_HTTP_LOG_PHASE:                       日志模块处理阶段

&emsp;&emsp;
在内容产生阶段为了给一个 request 产生正确的响应，nginx 必须把这个 request 交给一个合适的 content handler 去处理。
如果这个 request 对应的 location 在配置文件中被明确指定了一个 content handler，那么 nginx 就可以通过对 location 的匹配直接找到这个对应的 handler，并把这个 request 交给这个 content handler 去处理。
这样的配置指令包括像 perl、flv、proxy_pass、mp4 等。

如果一个 request 对应的 location 并没有直接有配置的 content handler，那么 nginx 依次尝试:

+ 如果一个 location 里面有配置 random_index on，那么随机选择一个文件发送给客户端。
+ 如果一个 location 里面有配置 index 指令，那么发送 index 指令指明的文件发送给客户端。
+ 如果一个 location 里面有配置 autoindex on，那么就发送请求地址对应的服务端路径下的文件列表给客户端。
+ 如果这个 request 对应的 location 上有设置 gzip_static on，那么就查找是否有对应的 .gz 文件存在，有的话就发送这个给客户端(客户端支持 gzip 的情况下)。
+ 请求的 URI 如果对应一个静态文件，static module 就发送静态文件的内容到客户端。

&emsp;&emsp;
内容产生阶段完成以后，生成的输出会被传递到 filter 模块去进行处理。
filter 模块也是与 location 相关的。
所有的 fiter 模块都被组织成一条链，输出会依次穿越所有的 filter，直到有一个 filter 模块的返回值表明已经处理完成。

这里列举几个常见的 filter 模块，例如：

+ server-side includes。
+ XSLT filtering。
+ 图像缩放之类的。
+ gzip 压缩。

&emsp;&emsp;
在所有的 filter 中，有几个 filter 模块需要关注一下。
按照调用的顺序依次说明如下：

+ write:    写输出到客户端，实际上是写到连接对应的 socket 上。
+ postpone: 这个 filter 是负责 subrequest 的，也就是子请求的。
+ copy:     将一些需要复制的 buf (文件或者内存)重新复制一份然后交给剩余的 body filter 处理。
